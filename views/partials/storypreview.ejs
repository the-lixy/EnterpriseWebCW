<!-- Template for displaying information about stories for the home page -->

<!-- script for allowing user to rate individual stories -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Select every rating container on the page
        const ratingContainers = document.querySelectorAll('.rating-container');
    
        ratingContainers.forEach(container => {
        const stars = container.querySelectorAll('.rating-star');
    
          stars.forEach(star => {
            star.addEventListener('click', () => {
                const index = parseInt(star.dataset.index);

                // Remove 'checked' from all stars in this container
                stars.forEach(s => s.classList.remove('checked'));

                // Add 'checked' up to the clicked star
                for (let i = 0; i < index; i++) {
                stars[i].classList.add('checked');
                }

                //console.log("Rated:", index);
                
                // Add rating to database
                const newRating = index;
                const storyId = container.dataset.storyId; // Get story id from data attribute

                // Send to server
                fetch('/rate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: storyId, rating: newRating }),
                })
                .then(res => res.json())
                .then(data => {
                //console.log("Rating saved:", data);
                })
                .catch(err => console.error("Error saving rating:", err));
            });
          });
        });
      });
 </script>

 <!-- script to mark stories as seen -->
 <script>
    document.addEventListener("DOMContentLoaded", () => {
      // get current cookie value
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
      }
  
      // set cookie
      function setCookie(name, value, days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));  // Set expiry
        const expires = `expires=${date.toUTCString()}`;
        document.cookie = `${name}=${value}; ${expires}; path=/`;
      }

      
  
      // mark story as seen
      function markAsSeen(storyId) {
        let seenStories = getCookie('seenStories');
        if (seenStories) {
          seenStories = JSON.parse(seenStories); // Parse existing cookie
        } else {
          seenStories = []; // Initialize empty array if cookie doesn't exist
        }
  
        if (!seenStories.includes(storyId)) {
          seenStories.push(storyId); // Add story ID if not already seen
          setCookie('seenStories', JSON.stringify(seenStories), 7); // Store the updated list in a cookie for 7 days
        }
      }

      function testFunc(storyId){
        console.log("it works!");
        console.log(storyId);
      }

      document.getElementById("storyLink").addEventListener("click", testFunc); 
    });
  </script>

<div class="container">
    <% if (stories.length > 0) { %>
    <% stories.forEach(story => { %>

    <!-- only display private story if user is logged in -->
    <% if (story.visibility == "private" && username || story.visibility == "public"){ %>

    <!-- display message if story is private -->
    <% if (story.visibility == "private"){ %>
        <div class="row"> <p> *private story </p></div>
    <%} %>


    <h4 style="display:inline"> <a href="/story?id=<%= story._id %>" class = "storyLink" onClick="testFunc('<% story._id %>')"> <%= story.title %> </a> </h4> <p style="display:inline"> by <%=story.author %> </p>
    <!-- genre & rating boxes -->
    <div class="row">

        <div class="col-sm-1"> 
            <p> <%= story.genre %> </p>
        </div>

        <!-- average rating of the story -->
        <div class="avg-rating-container, col-sm-2"> 
            <% if (story.rating > 0){ %>
            <% for (let i = 1; i <= 5; i++) { %>
                <span class="fa fa-star <%= i <= story.rating ? 'checked' : '' %>"></span>
            <% }}else{ %>
                <p display="inline"> no ratings yet </p>
            <% } %>
        </div>

        <!-- number of ratings the story has recieved -->
        <% if (story.rating > 0){ %>
                <div class="col-sm-1">
                    <p> <%= story.numratings %> ratings </p>
                </div>
        <% } %>

    </div>

    <!-- define how many characters of the story should be previewed -->
    <% num = 100 %>
    <p><%= story.story.length > num ? story.story.slice(0, num).split(" ").slice(0, -1).join(" ") + '...' : story.story %></p>

    <div class="rating-container" data-story-id="<%= story._id %>">
        <p style="display:inline"> Click to leave a rating: </p>
        <%- include('../partials/rating'); %>
    </div>

    <br><br>

    <%} %>
    <% }) %>
    <% } else { %>
      <p>No stories yet!</p>
    <% } %>

</div>